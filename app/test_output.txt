============================= test session starts ==============================
platform linux -- Python 3.13.4, pytest-8.4.2, pluggy-1.6.0 -- /venv/bin/python
rootdir: /app
configfile: pytest.ini
plugins: asyncio-1.0.0, anyio-4.12.0
asyncio: mode=Mode.AUTO, asyncio_default_fixture_loop_scope=module, asyncio_default_test_loop_scope=function
collecting ... collected 2 items

tests/integration/test_book_search.py::test_search_books_integration FAILED [ 50%]
tests/integration/test_book_search.py::test_search_books_empty_query PASSED [100%]

=================================== FAILURES ===================================
________________________ test_search_books_integration _________________________
  + Exception Group Traceback (most recent call last):
  |   File "/venv/lib/python3.13/site-packages/starlette/_utils.py", line 76, in collapse_excgroups
  |     yield
  |   File "/venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 177, in __call__
  |     async with anyio.create_task_group() as task_group:
  |                ~~~~~~~~~~~~~~~~~~~~~~~^^
  |   File "/venv/lib/python3.13/site-packages/anyio/_backends/_asyncio.py", line 783, in __aexit__
  |     raise BaseExceptionGroup(
  |         "unhandled errors in a TaskGroup", self._exceptions
  |     ) from None
  | ExceptionGroup: unhandled errors in a TaskGroup (1 sub-exception)
  +-+---------------- 1 ----------------
    | Traceback (most recent call last):
    |   File "/venv/lib/python3.13/site-packages/_pytest/runner.py", line 344, in from_call
    |     result: TResult | None = func()
    |                              ~~~~^^
    |   File "/venv/lib/python3.13/site-packages/_pytest/runner.py", line 246, in <lambda>
    |     lambda: runtest_hook(item=item, **kwds), when=when, reraise=reraise
    |             ~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^
    |   File "/venv/lib/python3.13/site-packages/pluggy/_hooks.py", line 512, in __call__
    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)
    |            ~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/venv/lib/python3.13/site-packages/pluggy/_manager.py", line 120, in _hookexec
    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)
    |            ~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/venv/lib/python3.13/site-packages/pluggy/_callers.py", line 167, in _multicall
    |     raise exception
    |   File "/venv/lib/python3.13/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |     ~~~~~~~~~~~~~~^^^^^^^^^^^
    |   File "/venv/lib/python3.13/site-packages/_pytest/logging.py", line 850, in pytest_runtest_call
    |     yield
    |   File "/venv/lib/python3.13/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |     ~~~~~~~~~~~~~~^^^^^^^^^^^
    |   File "/venv/lib/python3.13/site-packages/_pytest/capture.py", line 900, in pytest_runtest_call
    |     return (yield)
    |             ^^^^^
    |   File "/venv/lib/python3.13/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |     ~~~~~~~~~~~~~~^^^^^^^^^^^
    |   File "/venv/lib/python3.13/site-packages/_pytest/skipping.py", line 263, in pytest_runtest_call
    |     return (yield)
    |             ^^^^^
    |   File "/venv/lib/python3.13/site-packages/pluggy/_callers.py", line 121, in _multicall
    |     res = hook_impl.function(*args)
    |   File "/venv/lib/python3.13/site-packages/_pytest/runner.py", line 178, in pytest_runtest_call
    |     item.runtest()
    |     ~~~~~~~~~~~~^^
    |   File "/venv/lib/python3.13/site-packages/pytest_asyncio/plugin.py", line 508, in runtest
    |     super().runtest()
    |     ~~~~~~~~~~~~~~~^^
    |   File "/venv/lib/python3.13/site-packages/_pytest/python.py", line 1671, in runtest
    |     self.ihook.pytest_pyfunc_call(pyfuncitem=self)
    |     ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^
    |   File "/venv/lib/python3.13/site-packages/pluggy/_hooks.py", line 512, in __call__
    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)
    |            ~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/venv/lib/python3.13/site-packages/pluggy/_manager.py", line 120, in _hookexec
    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)
    |            ~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/venv/lib/python3.13/site-packages/pluggy/_callers.py", line 167, in _multicall
    |     raise exception
    |   File "/venv/lib/python3.13/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |     ~~~~~~~~~~~~~~^^^^^^^^^^^
    |   File "/venv/lib/python3.13/site-packages/pluggy/_callers.py", line 53, in run_old_style_hookwrapper
    |     return result.get_result()
    |            ~~~~~~~~~~~~~~~~~^^
    |   File "/venv/lib/python3.13/site-packages/pluggy/_result.py", line 103, in get_result
    |     raise exc.with_traceback(tb)
    |   File "/venv/lib/python3.13/site-packages/pluggy/_callers.py", line 38, in run_old_style_hookwrapper
    |     res = yield
    |           ^^^^^
    |   File "/venv/lib/python3.13/site-packages/pluggy/_callers.py", line 121, in _multicall
    |     res = hook_impl.function(*args)
    |   File "/venv/lib/python3.13/site-packages/_pytest/python.py", line 157, in pytest_pyfunc_call
    |     result = testfunction(**testargs)
    |   File "/venv/lib/python3.13/site-packages/pytest_asyncio/plugin.py", line 773, in inner
    |     _loop.run_until_complete(task)
    |     ~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^
    |   File "/usr/local/lib/python3.13/asyncio/base_events.py", line 725, in run_until_complete
    |     return future.result()
    |            ~~~~~~~~~~~~~^^
    |   File "/app/tests/integration/test_book_search.py", line 9, in test_search_books_integration
    |     response = await client.get("/api/v1/books/search?q=толстой")
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/venv/lib/python3.13/site-packages/httpx/_client.py", line 1768, in get
    |     return await self.request(
    |            ^^^^^^^^^^^^^^^^^^^
    |     ...<9 lines>...
    |     )
    |     ^
    |   File "/venv/lib/python3.13/site-packages/httpx/_client.py", line 1540, in request
    |     return await self.send(request, auth=auth, follow_redirects=follow_redirects)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/venv/lib/python3.13/site-packages/httpx/_client.py", line 1629, in send
    |     response = await self._send_handling_auth(
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |     ...<4 lines>...
    |     )
    |     ^
    |   File "/venv/lib/python3.13/site-packages/httpx/_client.py", line 1657, in _send_handling_auth
    |     response = await self._send_handling_redirects(
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |     ...<3 lines>...
    |     )
    |     ^
    |   File "/venv/lib/python3.13/site-packages/httpx/_client.py", line 1694, in _send_handling_redirects
    |     response = await self._send_single_request(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/venv/lib/python3.13/site-packages/httpx/_client.py", line 1730, in _send_single_request
    |     response = await transport.handle_async_request(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/venv/lib/python3.13/site-packages/httpx/_transports/asgi.py", line 170, in handle_async_request
    |     await self.app(scope, receive, send)
    |   File "/venv/lib/python3.13/site-packages/fastapi/applications.py", line 1054, in __call__
    |     await super().__call__(scope, receive, send)
    |   File "/venv/lib/python3.13/site-packages/starlette/applications.py", line 112, in __call__
    |     await self.middleware_stack(scope, receive, send)
    |   File "/venv/lib/python3.13/site-packages/starlette/middleware/errors.py", line 187, in __call__
    |     raise exc
    |   File "/venv/lib/python3.13/site-packages/starlette/middleware/errors.py", line 165, in __call__
    |     await self.app(scope, receive, _send)
    |   File "/venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 176, in __call__
    |     with recv_stream, send_stream, collapse_excgroups():
    |                                    ~~~~~~~~~~~~~~~~~~^^
    |   File "/usr/local/lib/python3.13/contextlib.py", line 162, in __exit__
    |     self.gen.throw(value)
    |     ~~~~~~~~~~~~~~^^^^^^^
    |   File "/venv/lib/python3.13/site-packages/starlette/_utils.py", line 82, in collapse_excgroups
    |     raise exc
    |   File "/venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 178, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/app/main.py", line 48, in log_request_response
    |     response = await call_next(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 156, in call_next
    |     raise app_exc
    |   File "/venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 141, in coro
    |     await self.app(scope, receive_or_disconnect, send_no_error)
    |   File "/venv/lib/python3.13/site-packages/starlette/middleware/cors.py", line 85, in __call__
    |     await self.app(scope, receive, send)
    |   File "/venv/lib/python3.13/site-packages/starlette/middleware/exceptions.py", line 62, in __call__
    |     await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
    |   File "/venv/lib/python3.13/site-packages/starlette/_exception_handler.py", line 53, in wrapped_app
    |     raise exc
    |   File "/venv/lib/python3.13/site-packages/starlette/_exception_handler.py", line 42, in wrapped_app
    |     await app(scope, receive, sender)
    |   File "/venv/lib/python3.13/site-packages/starlette/routing.py", line 714, in __call__
    |     await self.middleware_stack(scope, receive, send)
    |   File "/venv/lib/python3.13/site-packages/starlette/routing.py", line 734, in app
    |     await route.handle(scope, receive, send)
    |   File "/venv/lib/python3.13/site-packages/starlette/routing.py", line 288, in handle
    |     await self.app(scope, receive, send)
    |   File "/venv/lib/python3.13/site-packages/starlette/routing.py", line 76, in app
    |     await wrap_app_handling_exceptions(app, request)(scope, receive, send)
    |   File "/venv/lib/python3.13/site-packages/starlette/_exception_handler.py", line 53, in wrapped_app
    |     raise exc
    |   File "/venv/lib/python3.13/site-packages/starlette/_exception_handler.py", line 42, in wrapped_app
    |     await app(scope, receive, sender)
    |   File "/venv/lib/python3.13/site-packages/starlette/routing.py", line 73, in app
    |     response = await f(request)
    |                ^^^^^^^^^^^^^^^^
    |   File "/venv/lib/python3.13/site-packages/fastapi/routing.py", line 301, in app
    |     raw_response = await run_endpoint_function(
    |                    ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |     ...<3 lines>...
    |     )
    |     ^
    |   File "/venv/lib/python3.13/site-packages/fastapi/routing.py", line 212, in run_endpoint_function
    |     return await dependant.call(**values)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/app/api/v1/books.py", line 19, in search_books
    |     return await service.search(q)
    |            ^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/app/domain/services/book_service.py", line 24, in search
    |     return await self.repository.search(query=query)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/app/infrastructure/repositories/book_repo.py", line 35, in search
    |     return [self.domain_model.model_validate(row) for row in rows]
    |             ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^
    |   File "/venv/lib/python3.13/site-packages/pydantic/main.py", line 716, in model_validate
    |     return cls.__pydantic_validator__.validate_python(
    |            ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^
    |         obj,
    |         ^^^^
    |     ...<5 lines>...
    |         by_name=by_name,
    |         ^^^^^^^^^^^^^^^^
    |     )
    |     ^
    | pydantic_core._pydantic_core.ValidationError: 1 validation error for Book
    |   Input should be a valid dictionary or object to extract fields from [type=model_attributes_type, input_value=181047, input_type=int]
    |     For further information visit https://errors.pydantic.dev/2.12/v/model_attributes_type
    +------------------------------------

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/app/tests/integration/test_book_search.py", line 9, in test_search_books_integration
    response = await client.get("/api/v1/books/search?q=толстой")
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/venv/lib/python3.13/site-packages/httpx/_client.py", line 1768, in get
    return await self.request(
           ^^^^^^^^^^^^^^^^^^^
    ...<9 lines>...
    )
    ^
  File "/venv/lib/python3.13/site-packages/httpx/_client.py", line 1540, in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/venv/lib/python3.13/site-packages/httpx/_client.py", line 1629, in send
    response = await self._send_handling_auth(
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    ...<4 lines>...
    )
    ^
  File "/venv/lib/python3.13/site-packages/httpx/_client.py", line 1657, in _send_handling_auth
    response = await self._send_handling_redirects(
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    ...<3 lines>...
    )
    ^
  File "/venv/lib/python3.13/site-packages/httpx/_client.py", line 1694, in _send_handling_redirects
    response = await self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/venv/lib/python3.13/site-packages/httpx/_client.py", line 1730, in _send_single_request
    response = await transport.handle_async_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/venv/lib/python3.13/site-packages/httpx/_transports/asgi.py", line 170, in handle_async_request
    await self.app(scope, receive, send)
  File "/venv/lib/python3.13/site-packages/fastapi/applications.py", line 1054, in __call__
    await super().__call__(scope, receive, send)
  File "/venv/lib/python3.13/site-packages/starlette/applications.py", line 112, in __call__
    await self.middleware_stack(scope, receive, send)
  File "/venv/lib/python3.13/site-packages/starlette/middleware/errors.py", line 187, in __call__
    raise exc
  File "/venv/lib/python3.13/site-packages/starlette/middleware/errors.py", line 165, in __call__
    await self.app(scope, receive, _send)
  File "/venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 176, in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ~~~~~~~~~~~~~~~~~~^^
  File "/usr/local/lib/python3.13/contextlib.py", line 162, in __exit__
    self.gen.throw(value)
    ~~~~~~~~~~~~~~^^^^^^^
  File "/venv/lib/python3.13/site-packages/starlette/_utils.py", line 82, in collapse_excgroups
    raise exc
  File "/venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 178, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/app/main.py", line 48, in log_request_response
    response = await call_next(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^
  File "/venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 156, in call_next
    raise app_exc
  File "/venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 141, in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
  File "/venv/lib/python3.13/site-packages/starlette/middleware/cors.py", line 85, in __call__
    await self.app(scope, receive, send)
  File "/venv/lib/python3.13/site-packages/starlette/middleware/exceptions.py", line 62, in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
  File "/venv/lib/python3.13/site-packages/starlette/_exception_handler.py", line 53, in wrapped_app
    raise exc
  File "/venv/lib/python3.13/site-packages/starlette/_exception_handler.py", line 42, in wrapped_app
    await app(scope, receive, sender)
  File "/venv/lib/python3.13/site-packages/starlette/routing.py", line 714, in __call__
    await self.middleware_stack(scope, receive, send)
  File "/venv/lib/python3.13/site-packages/starlette/routing.py", line 734, in app
    await route.handle(scope, receive, send)
  File "/venv/lib/python3.13/site-packages/starlette/routing.py", line 288, in handle
    await self.app(scope, receive, send)
  File "/venv/lib/python3.13/site-packages/starlette/routing.py", line 76, in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
  File "/venv/lib/python3.13/site-packages/starlette/_exception_handler.py", line 53, in wrapped_app
    raise exc
  File "/venv/lib/python3.13/site-packages/starlette/_exception_handler.py", line 42, in wrapped_app
    await app(scope, receive, sender)
  File "/venv/lib/python3.13/site-packages/starlette/routing.py", line 73, in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
  File "/venv/lib/python3.13/site-packages/fastapi/routing.py", line 301, in app
    raw_response = await run_endpoint_function(
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    ...<3 lines>...
    )
    ^
  File "/venv/lib/python3.13/site-packages/fastapi/routing.py", line 212, in run_endpoint_function
    return await dependant.call(**values)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/app/api/v1/books.py", line 19, in search_books
    return await service.search(q)
           ^^^^^^^^^^^^^^^^^^^^^^^
  File "/app/domain/services/book_service.py", line 24, in search
    return await self.repository.search(query=query)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/app/infrastructure/repositories/book_repo.py", line 35, in search
    return [self.domain_model.model_validate(row) for row in rows]
            ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^
  File "/venv/lib/python3.13/site-packages/pydantic/main.py", line 716, in model_validate
    return cls.__pydantic_validator__.validate_python(
           ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^
        obj,
        ^^^^
    ...<5 lines>...
        by_name=by_name,
        ^^^^^^^^^^^^^^^^
    )
    ^
pydantic_core._pydantic_core.ValidationError: 1 validation error for Book
  Input should be a valid dictionary or object to extract fields from [type=model_attributes_type, input_value=181047, input_type=int]
    For further information visit https://errors.pydantic.dev/2.12/v/model_attributes_type

During handling of the above exception, another exception occurred:

client = <httpx.AsyncClient object at 0xffff8b802e40>

    @pytest.mark.asyncio
    @pytest.mark.integration
    async def test_search_books_integration(client: AsyncClient):
        # Используем `client` фикстуру (предполагаем наличие conftest.py)
>       response = await client.get("/api/v1/books/search?q=толстой")
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/integration/test_book_search.py:9: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
/venv/lib/python3.13/site-packages/httpx/_client.py:1768: in get
    return await self.request(
/venv/lib/python3.13/site-packages/httpx/_client.py:1540: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/venv/lib/python3.13/site-packages/httpx/_client.py:1629: in send
    response = await self._send_handling_auth(
/venv/lib/python3.13/site-packages/httpx/_client.py:1657: in _send_handling_auth
    response = await self._send_handling_redirects(
/venv/lib/python3.13/site-packages/httpx/_client.py:1694: in _send_handling_redirects
    response = await self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/venv/lib/python3.13/site-packages/httpx/_client.py:1730: in _send_single_request
    response = await transport.handle_async_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/venv/lib/python3.13/site-packages/httpx/_transports/asgi.py:170: in handle_async_request
    await self.app(scope, receive, send)
/venv/lib/python3.13/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
/venv/lib/python3.13/site-packages/starlette/applications.py:112: in __call__
    await self.middleware_stack(scope, receive, send)
/venv/lib/python3.13/site-packages/starlette/middleware/errors.py:187: in __call__
    raise exc
/venv/lib/python3.13/site-packages/starlette/middleware/errors.py:165: in __call__
    await self.app(scope, receive, _send)
/venv/lib/python3.13/site-packages/starlette/middleware/base.py:176: in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ^^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.13/contextlib.py:162: in __exit__
    self.gen.throw(value)
/venv/lib/python3.13/site-packages/starlette/_utils.py:82: in collapse_excgroups
    raise exc
/venv/lib/python3.13/site-packages/starlette/middleware/base.py:178: in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
main.py:48: in log_request_response
    response = await call_next(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^
/venv/lib/python3.13/site-packages/starlette/middleware/base.py:156: in call_next
    raise app_exc
/venv/lib/python3.13/site-packages/starlette/middleware/base.py:141: in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
/venv/lib/python3.13/site-packages/starlette/middleware/cors.py:85: in __call__
    await self.app(scope, receive, send)
/venv/lib/python3.13/site-packages/starlette/middleware/exceptions.py:62: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
/venv/lib/python3.13/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
/venv/lib/python3.13/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
/venv/lib/python3.13/site-packages/starlette/routing.py:714: in __call__
    await self.middleware_stack(scope, receive, send)
/venv/lib/python3.13/site-packages/starlette/routing.py:734: in app
    await route.handle(scope, receive, send)
/venv/lib/python3.13/site-packages/starlette/routing.py:288: in handle
    await self.app(scope, receive, send)
/venv/lib/python3.13/site-packages/starlette/routing.py:76: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
/venv/lib/python3.13/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
/venv/lib/python3.13/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
/venv/lib/python3.13/site-packages/starlette/routing.py:73: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
/venv/lib/python3.13/site-packages/fastapi/routing.py:301: in app
    raw_response = await run_endpoint_function(
/venv/lib/python3.13/site-packages/fastapi/routing.py:212: in run_endpoint_function
    return await dependant.call(**values)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
api/v1/books.py:19: in search_books
    return await service.search(q)
           ^^^^^^^^^^^^^^^^^^^^^^^
domain/services/book_service.py:24: in search
    return await self.repository.search(query=query)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <infrastructure.repositories.book_repo.BookRepo object at 0xffff8b6b8d70>
query = 'толстой'

    async def search(self, query: str) -> list[TDomain]:
        # Используем FTS5 поиск с сортировкой по релевантности (rank)
        # books_fts - это виртуальная таблица
        stmt = text("""
            SELECT books.* FROM books
            JOIN books_fts ON books.id = books_fts.rowid
            WHERE books_fts MATCH :query
            ORDER BY rank
        """)
    
        try:
            result = await self.db.execute(stmt, {"query": query})
        except SQLAlchemyError as ex:
            raise RepositoryException(str(ex))
    
        rows = result.scalars().all()
>       return [self.domain_model.model_validate(row) for row in rows]
                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
E       pydantic_core._pydantic_core.ValidationError: 1 validation error for Book
E         Input should be a valid dictionary or object to extract fields from [type=model_attributes_type, input_value=181047, input_type=int]
E           For further information visit https://errors.pydantic.dev/2.12/v/model_attributes_type

infrastructure/repositories/book_repo.py:35: ValidationError
---------------------------- Captured stderr setup -----------------------------
2025-12-10 01:04:02,061 - asyncio - DEBUG - Using selector: EpollSelector
2025-12-10 01:04:02,061 - asyncio - DEBUG - Using selector: EpollSelector
2025-12-10 01:04:02,062 - aiosqlite - DEBUG - executing <function connect.<locals>.connector at 0xffff8b6d8ea0>
2025-12-10 01:04:02,062 - aiosqlite - DEBUG - operation <function connect.<locals>.connector at 0xffff8b6d8ea0> completed
2025-12-10 01:04:02,062 - aiosqlite - DEBUG - executing functools.partial(<built-in method create_function of sqlite3.Connection object at 0xffff8b6d0a90>, 'regexp', 2, <function SQLiteDialect_pysqlite.on_connect.<locals>.regexp at 0xffff8b6d8720>, deterministic=True)
2025-12-10 01:04:02,062 - aiosqlite - DEBUG - operation functools.partial(<built-in method create_function of sqlite3.Connection object at 0xffff8b6d0a90>, 'regexp', 2, <function SQLiteDialect_pysqlite.on_connect.<locals>.regexp at 0xffff8b6d8720>, deterministic=True) completed
2025-12-10 01:04:02,062 - aiosqlite - DEBUG - executing functools.partial(<built-in method create_function of sqlite3.Connection object at 0xffff8b6d0a90>, 'floor', 1, <built-in function floor>, deterministic=True)
2025-12-10 01:04:02,062 - aiosqlite - DEBUG - operation functools.partial(<built-in method create_function of sqlite3.Connection object at 0xffff8b6d0a90>, 'floor', 1, <built-in function floor>, deterministic=True) completed
2025-12-10 01:04:02,062 - aiosqlite - DEBUG - executing functools.partial(<built-in method cursor of sqlite3.Connection object at 0xffff8b6d0a90>)
2025-12-10 01:04:02,062 - aiosqlite - DEBUG - operation functools.partial(<built-in method cursor of sqlite3.Connection object at 0xffff8b6d0a90>) completed
2025-12-10 01:04:02,062 - aiosqlite - DEBUG - executing functools.partial(<built-in method execute of sqlite3.Cursor object at 0xffff8b74e740>, 'PRAGMA read_uncommitted', [])
2025-12-10 01:04:02,063 - aiosqlite - DEBUG - operation functools.partial(<built-in method execute of sqlite3.Cursor object at 0xffff8b74e740>, 'PRAGMA read_uncommitted', []) completed
2025-12-10 01:04:02,063 - aiosqlite - DEBUG - executing functools.partial(<built-in method fetchall of sqlite3.Cursor object at 0xffff8b74e740>)
2025-12-10 01:04:02,063 - aiosqlite - DEBUG - operation functools.partial(<built-in method fetchall of sqlite3.Cursor object at 0xffff8b74e740>) completed
2025-12-10 01:04:02,063 - aiosqlite - DEBUG - executing functools.partial(<built-in method close of sqlite3.Cursor object at 0xffff8b74e740>)
2025-12-10 01:04:02,063 - aiosqlite - DEBUG - operation functools.partial(<built-in method close of sqlite3.Cursor object at 0xffff8b74e740>) completed
2025-12-10 01:04:02,063 - aiosqlite - DEBUG - executing functools.partial(<built-in method rollback of sqlite3.Connection object at 0xffff8b6d0a90>)
2025-12-10 01:04:02,063 - aiosqlite - DEBUG - operation functools.partial(<built-in method rollback of sqlite3.Connection object at 0xffff8b6d0a90>) completed
2025-12-10 01:04:02,063 - asyncio - DEBUG - Using selector: EpollSelector
------------------------------ Captured log setup ------------------------------
DEBUG    asyncio:selector_events.py:64 Using selector: EpollSelector
DEBUG    asyncio:selector_events.py:64 Using selector: EpollSelector
DEBUG    aiosqlite:core.py:104 executing <function connect.<locals>.connector at 0xffff8b6d8ea0>
DEBUG    aiosqlite:core.py:106 operation <function connect.<locals>.connector at 0xffff8b6d8ea0> completed
DEBUG    aiosqlite:core.py:104 executing functools.partial(<built-in method create_function of sqlite3.Connection object at 0xffff8b6d0a90>, 'regexp', 2, <function SQLiteDialect_pysqlite.on_connect.<locals>.regexp at 0xffff8b6d8720>, deterministic=True)
DEBUG    aiosqlite:core.py:106 operation functools.partial(<built-in method create_function of sqlite3.Connection object at 0xffff8b6d0a90>, 'regexp', 2, <function SQLiteDialect_pysqlite.on_connect.<locals>.regexp at 0xffff8b6d8720>, deterministic=True) completed
DEBUG    aiosqlite:core.py:104 executing functools.partial(<built-in method create_function of sqlite3.Connection object at 0xffff8b6d0a90>, 'floor', 1, <built-in function floor>, deterministic=True)
DEBUG    aiosqlite:core.py:106 operation functools.partial(<built-in method create_function of sqlite3.Connection object at 0xffff8b6d0a90>, 'floor', 1, <built-in function floor>, deterministic=True) completed
DEBUG    aiosqlite:core.py:104 executing functools.partial(<built-in method cursor of sqlite3.Connection object at 0xffff8b6d0a90>)
DEBUG    aiosqlite:core.py:106 operation functools.partial(<built-in method cursor of sqlite3.Connection object at 0xffff8b6d0a90>) completed
DEBUG    aiosqlite:core.py:104 executing functools.partial(<built-in method execute of sqlite3.Cursor object at 0xffff8b74e740>, 'PRAGMA read_uncommitted', [])
DEBUG    aiosqlite:core.py:106 operation functools.partial(<built-in method execute of sqlite3.Cursor object at 0xffff8b74e740>, 'PRAGMA read_uncommitted', []) completed
DEBUG    aiosqlite:core.py:104 executing functools.partial(<built-in method fetchall of sqlite3.Cursor object at 0xffff8b74e740>)
DEBUG    aiosqlite:core.py:106 operation functools.partial(<built-in method fetchall of sqlite3.Cursor object at 0xffff8b74e740>) completed
DEBUG    aiosqlite:core.py:104 executing functools.partial(<built-in method close of sqlite3.Cursor object at 0xffff8b74e740>)
DEBUG    aiosqlite:core.py:106 operation functools.partial(<built-in method close of sqlite3.Cursor object at 0xffff8b74e740>) completed
DEBUG    aiosqlite:core.py:104 executing functools.partial(<built-in method rollback of sqlite3.Connection object at 0xffff8b6d0a90>)
DEBUG    aiosqlite:core.py:106 operation functools.partial(<built-in method rollback of sqlite3.Connection object at 0xffff8b6d0a90>) completed
DEBUG    asyncio:selector_events.py:64 Using selector: EpollSelector
----------------------------- Captured stderr call -----------------------------
2025-12-10 01:04:02,064 - aiosqlite - DEBUG - executing functools.partial(<built-in method cursor of sqlite3.Connection object at 0xffff8b6d0a90>)
2025-12-10 01:04:02,064 - aiosqlite - DEBUG - operation functools.partial(<built-in method cursor of sqlite3.Connection object at 0xffff8b6d0a90>) completed
2025-12-10 01:04:02,064 - aiosqlite - DEBUG - executing functools.partial(<built-in method execute of sqlite3.Cursor object at 0xffff8b6deb40>, '\n            SELECT books.* FROM books\n            JOIN books_fts ON books.id = books_fts.rowid\n            WHERE books_fts MATCH ?\n            ORDER BY rank\n        ', ('толстой',))
2025-12-10 01:04:02,075 - aiosqlite - DEBUG - operation functools.partial(<built-in method execute of sqlite3.Cursor object at 0xffff8b6deb40>, '\n            SELECT books.* FROM books\n            JOIN books_fts ON books.id = books_fts.rowid\n            WHERE books_fts MATCH ?\n            ORDER BY rank\n        ', ('толстой',)) completed
2025-12-10 01:04:02,075 - aiosqlite - DEBUG - executing functools.partial(<built-in method fetchall of sqlite3.Cursor object at 0xffff8b6deb40>)
2025-12-10 01:04:02,097 - aiosqlite - DEBUG - operation functools.partial(<built-in method fetchall of sqlite3.Cursor object at 0xffff8b6deb40>) completed
2025-12-10 01:04:02,097 - aiosqlite - DEBUG - executing functools.partial(<built-in method close of sqlite3.Cursor object at 0xffff8b6deb40>)
2025-12-10 01:04:02,097 - aiosqlite - DEBUG - operation functools.partial(<built-in method close of sqlite3.Cursor object at 0xffff8b6deb40>) completed
------------------------------ Captured log call -------------------------------
DEBUG    aiosqlite:core.py:104 executing functools.partial(<built-in method cursor of sqlite3.Connection object at 0xffff8b6d0a90>)
DEBUG    aiosqlite:core.py:106 operation functools.partial(<built-in method cursor of sqlite3.Connection object at 0xffff8b6d0a90>) completed
DEBUG    aiosqlite:core.py:104 executing functools.partial(<built-in method execute of sqlite3.Cursor object at 0xffff8b6deb40>, '\n            SELECT books.* FROM books\n            JOIN books_fts ON books.id = books_fts.rowid\n            WHERE books_fts MATCH ?\n            ORDER BY rank\n        ', ('толстой',))
DEBUG    aiosqlite:core.py:106 operation functools.partial(<built-in method execute of sqlite3.Cursor object at 0xffff8b6deb40>, '\n            SELECT books.* FROM books\n            JOIN books_fts ON books.id = books_fts.rowid\n            WHERE books_fts MATCH ?\n            ORDER BY rank\n        ', ('толстой',)) completed
DEBUG    aiosqlite:core.py:104 executing functools.partial(<built-in method fetchall of sqlite3.Cursor object at 0xffff8b6deb40>)
DEBUG    aiosqlite:core.py:106 operation functools.partial(<built-in method fetchall of sqlite3.Cursor object at 0xffff8b6deb40>) completed
DEBUG    aiosqlite:core.py:104 executing functools.partial(<built-in method close of sqlite3.Cursor object at 0xffff8b6deb40>)
DEBUG    aiosqlite:core.py:106 operation functools.partial(<built-in method close of sqlite3.Cursor object at 0xffff8b6deb40>) completed
--------------------------- Captured stderr teardown ---------------------------
2025-12-10 01:04:02,195 - aiosqlite - DEBUG - executing functools.partial(<built-in method rollback of sqlite3.Connection object at 0xffff8b6d0a90>)
2025-12-10 01:04:02,195 - aiosqlite - DEBUG - operation functools.partial(<built-in method rollback of sqlite3.Connection object at 0xffff8b6d0a90>) completed
2025-12-10 01:04:02,195 - aiosqlite - DEBUG - executing functools.partial(<built-in method rollback of sqlite3.Connection object at 0xffff8b6d0a90>)
2025-12-10 01:04:02,195 - aiosqlite - DEBUG - operation functools.partial(<built-in method rollback of sqlite3.Connection object at 0xffff8b6d0a90>) completed
2025-12-10 01:04:02,195 - aiosqlite - DEBUG - executing functools.partial(<built-in method close of sqlite3.Connection object at 0xffff8b6d0a90>)
2025-12-10 01:04:02,195 - aiosqlite - DEBUG - operation functools.partial(<built-in method close of sqlite3.Connection object at 0xffff8b6d0a90>) completed
---------------------------- Captured log teardown -----------------------------
DEBUG    aiosqlite:core.py:104 executing functools.partial(<built-in method rollback of sqlite3.Connection object at 0xffff8b6d0a90>)
DEBUG    aiosqlite:core.py:106 operation functools.partial(<built-in method rollback of sqlite3.Connection object at 0xffff8b6d0a90>) completed
DEBUG    aiosqlite:core.py:104 executing functools.partial(<built-in method rollback of sqlite3.Connection object at 0xffff8b6d0a90>)
DEBUG    aiosqlite:core.py:106 operation functools.partial(<built-in method rollback of sqlite3.Connection object at 0xffff8b6d0a90>) completed
DEBUG    aiosqlite:core.py:104 executing functools.partial(<built-in method close of sqlite3.Connection object at 0xffff8b6d0a90>)
DEBUG    aiosqlite:core.py:106 operation functools.partial(<built-in method close of sqlite3.Connection object at 0xffff8b6d0a90>) completed
=========================== short test summary info ============================
FAILED tests/integration/test_book_search.py::test_search_books_integration
========================= 1 failed, 1 passed in 0.15s ==========================
